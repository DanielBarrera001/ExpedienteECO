@using ExpedienteECO.Entidades
@using Microsoft.EntityFrameworkCore
@inject ExpedienteECO.ApplicationDbContext _db

@{
    ViewData["Title"] = "Centro de Reportes";
}

<div class="container py-4">
    @* Encabezado con color de la escuela *@
    <div class="text-center mb-5">
        <div class="d-inline-block bg-soft-primario p-3 rounded-circle mb-3">
            <i class="bi bi-bar-chart-line-fill text-escuela-blue fs-1"></i>
        </div>
        <h2 class="fw-bold text-dark">Centro de Reportes y Estadísticas</h2>
        <p class="text-muted mx-auto" style="max-width: 600px;">
            Acceda a la información consolidada de la clínica escolar con los formatos oficiales.
        </p>
    </div>

    @* SECCIÓN 1: CONSULTAS MÉDICAS *@
    <div class="mb-5">
        <div class="d-flex align-items-center mb-4">
            <div class="bg-primary rounded-pill me-3" style="width: 5px; height: 30px; background-color: var(--escuela-blue) !important;"></div>
            <h4 class="fw-bold text-dark mb-0">Gestión de Consultas Médicas</h4>
        </div>

        <div class="row g-4">
            @* Reporte Diario *@
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm rounded-4 hover-card">
                    <div class="card-body p-4">
                        <div class="bg-soft-primario p-3 rounded-3 d-inline-block mb-3 text-escuela-blue">
                            <i class="bi bi-calendar-check fs-3"></i>
                        </div>
                        <h5 class="fw-bold mb-2">Atención Diaria</h5>
                        <p class="text-muted small mb-4">Bitácora completa de consultas atendidas hoy o en fecha específica.</p>

                        <form method="get" asp-action="Generar">
                            <input type="hidden" name="tipo" value="diario_consultas" />
                            <div class="mb-3">
                                <input type="date" name="fecha" class="form-control border-2 rounded-3" value="@DateTime.Today.ToString("yyyy-MM-dd")" required />
                            </div>
                            <button type="submit" class="btn btn-escuela-blue w-100 rounded-pill fw-bold">
                                <i class="bi bi-file-earmark-pdf me-2"></i>Generar PDF
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            @* Historial por Alumno *@
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm rounded-4 hover-card">
                    <div class="card-body p-4">
                        <div class="bg-soft-primario p-3 rounded-3 d-inline-block mb-3 text-escuela-blue">
                            <i class="bi bi-person-lines-fill fs-3"></i>
                        </div>
                        <h5 class="fw-bold mb-2">Expediente Alumno</h5>
                        <p class="text-muted small mb-4">Historial clínico detallado de un estudiante seleccionado.</p>

                        <form method="get" asp-action="Generar">
                            <input type="hidden" name="tipo" value="estudiante_historial" />
                            <div class="mb-3">
                                <select name="estudianteId" class="form-select select2-estudiante" required>
                                    <option value="">Buscar estudiante...</option>
                                    @foreach (var e in await _db.Estudiantes.OrderBy(e => e.NombreCompleto).ToListAsync())
                                    {
                                        <option value="@e.Id">@e.NombreCompleto</option>
                                    }
                                </select>
                            </div>
                            <button type="submit" class="btn btn-escuela-blue w-100 rounded-pill fw-bold">
                                <i class="bi bi-search me-2"></i>Generar Historial
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            @* Reporte de Motivos *@
            <div class="col-md-6 col-lg-4">
                <div class="card h-100 border-0 shadow-sm rounded-4 hover-card">
                    <div class="card-body p-4">
                        <div class="bg-soft-primario p-3 rounded-3 d-inline-block mb-3 text-escuela-blue">
                            <i class="bi bi-graph-up-arrow fs-3"></i>
                        </div>
                        <h5 class="fw-bold mb-2">Reporte de Motivos</h5>
                        <p class="text-muted small mb-4">Análisis de los motivos de consulta más comunes en el mes.</p>

                        <form method="get" asp-action="Generar">
                            <input type="hidden" name="tipo" value="mensual_motivos" />
                            <div class="mb-3">
                                <input type="month" name="fecha" class="form-control border-2 rounded-3" value="@DateTime.Today.ToString("yyyy-MM")" required />
                            </div>
                            <button type="submit" class="btn btn-escuela-blue w-100 rounded-pill fw-bold">
                                <i class="bi bi-pie-chart-fill me-2"></i>Ver Tendencias
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @* SECCIÓN 2: INSUMOS *@
    <div class="mb-4">
        <div class="d-flex align-items-center mb-4">
            <div class="bg-success rounded-pill me-3" style="width: 5px; height: 30px;"></div>
            <h4 class="fw-bold text-dark mb-0">Control de Insumos</h4>
        </div>

        <div class="row g-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                    <div class="card-body p-4 d-flex align-items-center">
                        <div class="bg-soft-danger p-4 rounded-4 text-danger me-4">
                            <i class="bi bi-lightning-charge-fill fs-1"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="fw-bold mb-1">Stock Crítico</h5>
                            <p class="text-muted small mb-3">Insumos por debajo del mínimo establecido.</p>
                            <a asp-action="Generar" asp-route-tipo="stock_bajo" class="btn btn-danger btn-sm rounded-pill px-4">
                                <i class="bi bi-download me-2"></i>Descargar PDF
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card border-0 shadow-sm rounded-4">
                    <div class="card-body p-4 d-flex align-items-center">
                        <div class="bg-soft-success p-4 rounded-4 text-success me-4">
                            <i class="bi bi-arrow-down-up fs-1"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h5 class="fw-bold mb-1">Movimientos</h5>
                            <p class="text-muted small mb-3">Registro de entradas y salidas de farmacia.</p>
                            <div class="d-flex gap-2">
                                <a asp-action="Generar" asp-route-tipo="movimientos_dia" class="btn btn-outline-success btn-sm rounded-pill px-3">Hoy</a>
                                <a asp-action="Generar" asp-route-tipo="movimientos_mes" class="btn btn-outline-success btn-sm rounded-pill px-3">Este Mes</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script>
        $(document).ready(function() {
            $('.select2-estudiante').select2({ theme: 'bootstrap-5' });
        });
    </script>
}